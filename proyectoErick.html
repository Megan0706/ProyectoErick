<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Prueba Examen - CRUD Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .card-body h5,
        .card-body h4 {
            margin-top: 0 !important;
            margin-bottom: 4px !important;
        }

        .card-body {
            padding-top: 10px !important;
            padding-bottom: 5px !important;
        }

        
        #successMessage {
            padding: 5px;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .success-message-bg {
            background-color: #d1e7dd; 
            color: #0f5132;
        }

        .error-message-bg {
            background-color: #f8d7da; 
            color: #842029;
        }

        
        .flex-grow-1.overflow-auto {
            max-height: calc(100vh - 220px); 
        }
    </style>
</head>
<body>
    <div class="container min-vh-100 py-3 d-flex flex-column">
        <div class="text-center mb-3">
            <h3>Registro de Usuarios del Hospital Juarez</h3>
        </div>

        <div class="row flex-grow-1 g-3">
            <div class="col-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <h4>Registro de Usuarios</h4>
                        <form id="registroForm" class="d-flex flex-column flex-grow-1">
                            <div class="mb-1">
                                <label for="name">Nombre:</label>
                                <input type="text" id="name" name="name" class="form-control" placeholder="Ingrese su nombre" required />
                            </div>
                            <div class="mb-1">
                                <label for="email">Correo:</label>
                                <input type="email" id="email" name="email" class="form-control" placeholder="Ingrese su correo"
                                       required />
                            </div>
                            <div class="row mb-1">
                                <div class="col-md-6">
                                    <label for="telefono">Telefono:</label>
                                    <input type="tel" id="telefono" name="telefono" class="form-control" placeholder="Numero de telefono"
                                           pattern="^\d{1,10}$" maxlength="10" required />

                                </div>
                                <div class="mb-1 col-md-6">
                                    <label for="fechaN">Fecha de Nacimiento</label>
                                    <input type="date" id="fechaN" name="fechaN" class="form-control" required />
                                </div>
                            </div>
                            <div class="row mb-1">
                                <div class="col-md-6">
                                    <label for="genero">Genero:</label>
                                    <select id="genero" name="genero" class="form-select" required>
                                        <option value="" disabled selected>Seleccionar</option>
                                        <option value="male">Hombre</option>
                                        <option value="female">Mujer</option>
                                        <option value="anything">Otros</option>
                                    </select>
                                </div>
                                <div class="mb-1 col-md-6">
                                    <label for="rfc">RFC *</label>
                                    <input type="text" id="rfc" name="rfc" class="form-control" placeholder="Introduce tu RFC" required
                                           pattern="^[A-Z√ë&]{3,4}\d{6}[A-Z0-9]{3}$" maxlength="13" />
                                </div>
                            </div>
                            <div class="mt-auto d-flex pt-2">
                                <button type="submit" class="btn btn-primary flex-grow-1" id="btnRegistrar">Registrar</button>
                                <button type="button" class="btn btn-secondary ms-2 flex-grow-1" id="btnCancelarEdicion" style="display: none;">Cancelar edici√≥n</button>
                            </div>
                        </form>
                        <div class="text-center d-none" id="successMessage"></div>
                    </div>
                </div>
            </div>

            <div class="col-8 d-flex flex-column">
                <div class="card shadow-sm flex-grow-1">
                    <div class="card-body p-1 d-flex flex-column">
                        <h5 class="text-center">Tabla Dinamica</h5>
                        <div class="flex-grow-1 overflow-auto">
                            <table class="table table-striped table-hover" id="tabla">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Tel√©fono</th>
                                        <th>Fecha Nacimiento</th>
                                        <th>RFC</th>
                                        <th>G√©nero</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaResultados">
                                    <tr>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    // --- CONFIGURACI√ìN DEL API ---
    const API_URL = 'http://localhost:3000/api/usuarios';

    // Referencias a elementos del DOM
    const tablaResultados = document.querySelector("#tablaResultados");
    const form = document.getElementById("registroForm");
    const mensajeExito = document.getElementById('successMessage');
    const btnRegistrar = document.getElementById('btnRegistrar');
    const btnCancelar = document.getElementById('btnCancelarEdicion');
    let idEnEdicion = null; // Usaremos el ID de MongoDB para la edici√≥n

    // Funciones Auxiliares
    function mostrarMensaje(texto, esExito = true) {
        mensajeExito.textContent = texto;
        mensajeExito.classList.remove('d-none', 'success-message-bg', 'error-message-bg');
        mensajeExito.classList.add(esExito ? 'success-message-bg' : 'error-message-bg');

        if (esExito) {
            setTimeout(() => mensajeExito.classList.add('d-none'), 3000);
        }
    }

    // üîÑ Funci√≥n de Leer (READ)
    async function mostrarTabla() {
        tablaResultados.innerHTML = "";
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Error al cargar los datos del servidor');
            
            const usuarios = await response.json();

            if (usuarios.length === 0) {
                tablaResultados.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros para mostrar.</td></tr>';
                return;
            }

            usuarios.forEach((user, i) => {
                let generoTexto = 'Otros';
                if (user.genero === 'male') generoTexto = 'Hombre';
                else if (user.genero === 'female') generoTexto = 'Mujer';

                const fechaNacimiento = new Date(user.fechaN).toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.telefono}</td>
                    <td>${fechaNacimiento}</td>
                    <td>${user.rfc}</td>
                    <td>${generoTexto}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editar('${user._id}')">Editar</button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="eliminar('${user._id}')">Eliminar</button>
                    </td>
                `;
                tablaResultados.appendChild(fila);
            });

        } catch (error) {
            console.error(error);
            tablaResultados.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‚ö†Ô∏è Error de conexi√≥n: ${error.message}</td></tr>`;
        }
    }

    // ‚úèÔ∏è Funci√≥n de Editar (UPDATE) - Cargar datos
    async function editar(id) {
        try {
            const response = await fetch(`${API_URL}/${id}`);
            if (!response.ok) throw new Error('Usuario no encontrado');
            
            const u = await response.json();
            
            // Cargar datos del usuario al formulario
            document.getElementById("name").value = u.name || "";
            document.getElementById("email").value = u.email || "";
            document.getElementById("telefono").value = u.telefono || "";
            // La fecha se carga directamente
            const fechaInput = document.getElementById("fechaN");
            fechaInput.value = u.fechaN ? new Date(u.fechaN).toISOString().split('T')[0] : "";
            
            document.getElementById("genero").value = u.genero || "";
            document.getElementById("rfc").value = u.rfc || "";

            idEnEdicion = u._id; // Guardamos el ID de Mongo
            
            // Cambiar la interfaz a modo edici√≥n
            btnCancelar.style.display = 'inline-block';
            btnRegistrar.textContent = 'Guardar cambios';
            mensajeExito.classList.add('d-none');

        } catch (error) {
            mostrarMensaje(`Error al cargar datos: ${error.message}`, false);
        }
    }

    // üóëÔ∏è Funci√≥n de Borrar (DELETE)
    async function eliminar(id) {
        if (!confirm("¬øEst√° seguro de que desea eliminar este registro?")) return;

        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.message || 'Error desconocido al eliminar');

            cancelarEdicion();
            mostrarTabla();
            mostrarMensaje("Registro eliminado correctamente", false);
            
        } catch (error) {
            mostrarMensaje(`Error al eliminar: ${error.message}`, false);
        }
    }
    
    // ‚ùå Funci√≥n de Cancelar Edici√≥n
    function cancelarEdicion() {
        form.reset();
        idEnEdicion = null;
        btnCancelar.style.display = 'none';
        btnRegistrar.textContent = 'Registrar';
        mensajeExito.classList.add('d-none');
    }

    // Listener para el bot√≥n Cancelar Edici√≥n
    btnCancelar.addEventListener('click', cancelarEdicion);

    // üöÄ Listener Principal - Crear (CREATE) y Actualizar (UPDATE)
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        // 1. Obtener los valores del formulario
        const userData = {
            name: document.getElementById("name").value.trim(),
            email: document.getElementById("email").value.trim(),
            telefono: document.getElementById("telefono").value.trim(),
            fechaN: document.getElementById("fechaN").value,
            genero: document.getElementById("genero").value,
            rfc: document.getElementById("rfc").value.trim(),
        };

        // Validaci√≥n b√°sica (se conf√≠a en el 'required' de HTML y en el backend)
        if (Object.values(userData).some(val => !val)) {
            mostrarMensaje("‚ùó Llena todos los campos antes de enviar.", false);
            return;
        }
        
        const method = idEnEdicion ? 'PUT' : 'POST';
        const url = idEnEdicion ? `${API_URL}/${idEnEdicion}` : API_URL;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (!response.ok) {
                // El backend devuelve un error (ej. duplicidad de RFC/Email)
                throw new Error(data.message || 'Error desconocido del servidor');
            }

            // √âxito
            const mensaje = idEnEdicion ? "Usuario actualizado correctamente" : "Usuario registrado correctamente";
            mostrarMensaje(mensaje);
            
            // Si fue una actualizaci√≥n, restablecemos la interfaz
            if (idEnEdicion) {
                cancelarEdicion();
            } else {
                form.reset();
            }

            mostrarTabla(); // Recargar la tabla con datos actualizados
            
        } catch (error) {
            mostrarMensaje(`Error: ${error.message}`, false);
        }
    });

    // üèÅ Inicializar
    mostrarTabla();
</script>